---
title: "Assignment2"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message    = FALSE,   # oculta mensajes
  warning    = FALSE,   # oculta warnings
  fig.align  = "center",
  fig.width  = 4.5,       # tamaño base de los gráficos (en pulgadas)
  fig.height = 3,
  dpi        = 120,
  out.width  = "70%",   # reduce tamaño en la página
  fig.show   = "hold"   # agrupa varias figuras del chunk en el mismo bloque
)
```

```{r, include=FALSE}
# Clear plots
if(!is.null(dev.list())) dev.off()

# Clean workspace
rm(list=ls())
```

# 1. Data preparation
After checking the dataset, we observe that many variable's observation's are left in blank, we set it to NA because it's missing data.

```{r}
# Loading data
df <- read.csv("aug_train.csv", header=T)
summary(df)

df[df == ""] <- NA
```
First, we check the missing data and zeros of the variables:

```{r}
check_na <- function(x) {
  na = sum(is.na(x))
  }
```

```{r}
results <- lapply(df, check_na)
results
```

## Numerical variables

### enrollee_id
We confirm that `enrollee_id` does not have duplicates or missing data, as we wanted, because it's the variable that identifies each enrollee. 

But this variable is not necessary for modelling because it doesn't have predictive power, so we remove it.

```{r}
sum(duplicated(df$enrollee_id))
sum(is.na(df$enrollee_id))
```

### city_development_index
The variable `city_development_index` has no NA and no severe outliers, only mild outliers, but we won't remove them.
```{r}
summary(df$city_development_index)
hist(df$city_development_index)

# Outliers
boxplot(df$city_development_index, horizontal = T)
varout <- summary(df$city_development_index)
iqr = varout[5]-varout[2]
usout <- varout[5]+3*iqr
lsout <- varout[2]-3*iqr
umout <- varout[5]+1.5*iqr
lmout <- varout[2]-1.5*iqr

sev_out <- which((df$city_development_index > usout) | (df$city_development_index < lsout))
mild_out <- which((df$city_development_index > umout) | (df$city_development_index < lmout))

boxplot(df$city_development_index, horizontal = T)
abline(v=usout,col='orange', add = T)
abline(v=lsout,col='orange', add = T)
abline(v=umout,col='orange', add = T)
abline(v=lmout,col='orange', add = T)
length(sev_out) #0
length(mild_out) #17

# Distribution
hist(df$city_development_index, freq = F)
m = mean(df$city_development_index)
std = sd(df$city_development_index)
curve(dnorm(x,m,std),add=T, col="red")
```

### training_hours
The variable `training_hours` does not have any NA.

```{r}
summary(df$training_hours)
hist(df$training_hours)

# Outliers
boxplot(df$training_hours, horizontal = T)
varout <- summary(df$training_hours)
iqr = varout[5]-varout[2]
usout <- varout[5]+3*iqr
lsout <- varout[2]-3*iqr
umout <- varout[5]+1.5*iqr
lmout <- varout[2]-1.5*iqr

sev_out <- which((df$training_hours > usout) | (df$training_hours < lsout))
length(sev_out) #275
mild_out <- which((df$training_hours > umout) | (df$training_hours < lmout))
length(mild_out) #984

boxplot(df$training_hours, horizontal = T)
abline(v=usout,col='orange', add = T)
abline(v=lsout,col='orange', add = T)
abline(v=umout,col='orange', add = T)
abline(v=lmout,col='orange', add = T)
sev_out #0
mild_out #0

# Distribution
hist(df$training_hours, freq = F)
m = mean(df$training_hours)
std = sd(df$training_hours)
curve(dnorm(x,m,std),add=T, col="red")
```


## Categorical variables

### target
The variable `target` is a binary variable that defines the positive or negative outcome of the prediction.

```{r}
sum(is.na(df$target))
length(unique(df$target)) #check number of unique categories -> 123
table_target <- sort(table(df$target))
head(table_target)   # cities with less frequence

df$target <- factor(df$target)
```

### city
The variable `city` has 123 levels and no NA, some cities show really low frequence.
This is a categorical variable, we convert it to factor.
```{r}
sum(is.na(df$city))
length(unique(df$city)) #check number of unique categories -> 123
table_city <- sort(table(df$city))
head(table_city)   # cities with less frequence

df$city <- factor(df$city)
```

### gender
The variable `gender` has 4508 NA and 4 unique categories: NA, Female, Male and Other.

To handle missing data, we can impute it later.

```{r}
sum(is.na(df$gender))
length(unique(df$gender)) #check number of unique categories
table_gender <- table(df$gender)
barplot(table_gender)

df$gender <- factor(df$gender)
```
### relevent_experience
The variable `relevent_experience` does not have missing data and it has 2 levels: 'Has relevant experience' and 'No relevant experience'

```{r}
sum(is.na(df$relevent_experience))
length(unique(df$relevent_experience)) #check number of unique categories
table_relevent_experience<- table(df$relevent_experience)
table_relevent_experience
barplot(table_relevent_experience)

df$relevent_experience <- factor(df$relevent_experience)
```
### enrolled_university
The variable `enrolled_university` has 386 NA and 4 levels: NA, 'Full time course' and 'no_enrollment' and 'Part time course'.

Like the variable `gender`, we impute it later.

```{r}
sum(is.na(df$enrolled_university))
length(unique(df$enrolled_university)) #check number of unique categories
table_enrolled_university <- table(df$enrolled_university)
table_enrolled_university
barplot(table_enrolled_university)

df$enrolled_university <- factor(df$enrolled_university)
```
### education_level
The variable `education_level` has 460 NA and 6 levels: NA, 'Graduate', 'High School','Masters','Phd' and 'Primary School'

To remove the NAs, we impute it later.

```{r}
sum(is.na(df$education_level))
length(unique(df$education_level)) #check number of unique categories
table_education_level <- table(df$education_level)
table_education_level
barplot(table_education_level)

df$education_level <- factor(df$education_level)
```
### major_discipline
The variable `major_discipline` has 2813 NA and 7 levels: NA, 'Arts', 'Business Degree','Humanities','No major','STEM' and 'Other'.

We impute it later.

```{r}
sum(is.na(df$major_discipline))
length(unique(df$major_discipline)) #check number of unique categories
table_major_discipline <- table(df$major_discipline)
table_major_discipline
barplot(table_major_discipline)

df$major_discipline <- factor(df$major_discipline)
```
### experience
The variable `experience` has 65 NA and 23 levels from <1 to >20. 

We group them in less levels.


```{r}
sum(is.na(df$experience))
length(unique(df$experience)) #check number of unique categories
table_experience <- table(df$experience)
barplot(table_experience)
```
We observe from the previous barplot that there are many people whose experience is 1 year, we make the groups by career stage and not separating equally. (NO SÉ!!!!!!!!!!!! PODEM CANVIAR-HO DESPRÉS)

MANTENIM LA VARIABLE ORIGINAL O DIRECTAMENT LA CONVERTIM EN ELS GROUPS

```{r}
exp_clean <- df$experience
exp_clean <- gsub("<1", "0", exp_clean) 
exp_clean <- gsub(">20", "21", exp_clean)

df$experience_num <- as.numeric(exp_clean)

df$experience_group <- cut(
  df$experience_num,
  breaks = c(-1, 1, 5, 10, Inf),
  labels = c("Junior", "Early", "Mid", "Senior")
)

barplot(table(df$experience_group))
```


### company_size
The variable `company_size` has 5938 NAs and 9 unique categories including NA.

We can regroup this variable as well.

```{r}
sum(is.na(df$company_size))
length(unique(df$company_size)) #check number of unique categories
unique(df$company_size)
table_company_size <- table(df$company_size)
barplot(table_company_size)
```
```{r}
df$company_size_group <- dplyr::case_when(
  df$company_size == "<10" ~ "Micro",
  df$company_size %in% c("10/49", "50-99") ~ "Small",
  df$company_size %in% c("100-500", "500-999") ~ "Medium",
  df$company_size == "1000-4999" ~ "Large",
  df$company_size %in% c("5000-9999", "10000") ~ "Very large"
)

df$company_size_group <- factor(df$company_size_group, levels = c("Micro", "Small", "Medium", "Large", "Very large"))

barplot(table(df$company_size_group))
```
### company_type
The variable `company_type` has 6140 NAs and 7 unique categories.

We will impute the missing values.

We can redefine the groups as well because it's really imbalanced.
```{r}
sum(is.na(df$company_type))
length(unique(df$company_type)) #check number of unique categories
unique(df$company_type)
table_company_type <- table(df$company_type)
barplot(table_company_type)
```
```{r}
df$company_type_group <- dplyr::case_when(
  df$company_type == "Pvt Ltd" ~ "Private",
  df$company_type == "Public Sector" ~ "Public",
  df$company_type %in% c("Early Stage Startup", "Funded Startup") ~ "Startup",
  df$company_type %in% c("NGO", "Other") ~ "Other"
)

df$company_type_group <- factor(
  df$company_type_group,
  levels = c("Private", "Public", "Startup", "Non-profit/Other")
)
barplot(table(df$company_type_group))
```

### last_new_job
The variable `last_new_job` has 423 NA and 7 unique categories including NA.
```{r}
sum(is.na(df$last_new_job))
length(unique(df$last_new_job)) #check number of unique categories
unique(df$last_new_job)
table_last_new_job <- table(df$last_new_job)
barplot(table_last_new_job)
```

## Imputation
We need to impute `gender`, `enrolled_university`, `education_level`,`major_discipline`,`experience_group`, `company_size_group`,`company_type_group`,`last_new_job`.

We try to impute with imputeMCA but the results show that it imputed the NA to the higher frequency group. Because of this, we use mice to impute and the validation results show that the imputations has not changed the proportions of the different levels of the variables, especially in the variables with less NAs.

```{r}
library(missMDA)
library(FactoMineR)

cat_vars <- df[, c("gender",
                   "enrolled_university",
                   "education_level",
                   "major_discipline",
                   "experience_group",
                   "company_size_group",
                   "company_type_group",
                   "last_new_job")]

#nb_dim <- estim_ncpMCA(cat_vars)  # automatically suggests number of components
#nb_dim$ncp   # 5

#imp_mca <- imputeMCA(cat_vars, ncp = 5)
#cat_imputed <- imp_mca$completeObs

#### USING MICE?
library(mice)
res.mice <- mice(df[c(2:8,12:13,16:18)], m = 1, maxit = 5, seed = 123)
dfimp <-complete(res.mice)
summary(dfimp)

# we put imputed variables back into original df
df[, c("gender",
       "enrolled_university",
       "education_level",
       "major_discipline",
       "company_size_group",
       "company_type_group",
       "last_new_job")] <- cat_imputed

summary(df)
```

Validation:
```{r}
vars <- c("gender",
          "enrolled_university",
          "education_level",
          "major_discipline",
          "experience_group",
          "company_size_group",
          "company_type_group",
          "last_new_job")

for (v in vars) {
  cat("\n------", v, "------\n")
  
  # Proportions BEFORE (ignoring NA)
  prop_before <- prop.table(table(df[[v]], useNA = "no"))
  
  # Proportions AFTER 
  prop_after  <- prop.table(table(dfimp[[v]]))
  
  print(round(prop_before, 4))
  print(round(prop_after, 4))
}

```




# 2. Profiling and Feature Selection




# 3. Modeling using numeric variables using transformations if needed



# 4. Residual analysis: unusual and influent data filtering




# 5. Adding factor main effects to the best model containing numeric variables





# 6. Residual analysis: unusual and influent data filtering





# 7. Adding factor main effects and interactions (limit your statement to order 2) to the best model containing numeric variables




# 8. Final Residual analysis: unusual and influent data filtering. Iterative process could be needed




# 9. Goodness of fit and Model Interpretation
